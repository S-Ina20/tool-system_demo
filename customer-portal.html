<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Three Lab - å†ç ”ç£¨ä¾é ¼ãƒãƒ¼ã‚¿ãƒ«</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c28;
    --border: #2a2a3a;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --text: #e8e8f0;
    --text-dim: #6b6b8a;
    --success: #00d68f;
    --warning: #ffaa00;
    --danger: #ff4757;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --font-body: 'Noto Sans JP', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app-shell {
    display: grid;
    grid-template-columns: 220px 1fr;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    height: 100vh;
  }

  .logo-area {
    padding: 24px 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .logo-title {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 800;
    color: var(--text);
    line-height: 1.2;
  }

  .logo-title span { color: var(--accent); }

  .customer-info {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-dim);
  }

  .customer-name {
    font-weight: 600;
    color: var(--text);
    font-size: 13px;
  }

  .nav {
    flex: 1;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-dim);
    border: 1px solid transparent;
  }

  .nav-item:hover { background: var(--surface2); color: var(--text); }

  .nav-item.active {
    background: rgba(0,229,255,0.08);
    color: var(--accent);
    border-color: rgba(0,229,255,0.2);
  }

  .nav-icon { font-size: 14px; width: 18px; text-align: center; }

  .status-badge {
    margin-left: auto;
    background: var(--warning);
    color: #000;
    font-size: 10px;
    font-family: var(--font-mono);
    padding: 2px 6px;
    border-radius: 100px;
    font-weight: 600;
  }

  .main {
    overflow-y: auto;
    min-height: 100vh;
  }

  .page { display: none; padding: 32px; }
  .page.active { display: block; }

  .page-header { margin-bottom: 28px; }

  .page-header h1 {
    font-family: var(--font-display);
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 4px;
  }

  .page-header p { color: var(--text-dim); font-size: 13px; }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
  }

  .stat-card.warn::before { background: var(--warning); }
  .stat-card.success::before { background: var(--success); }

  .stat-label {
    font-size: 11px;
    font-family: var(--font-mono);
    letter-spacing: 0.1em;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .stat-value {
    font-family: var(--font-display);
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
  }

  .stat-value.cyan { color: var(--accent); }
  .stat-value.warn { color: var(--warning); }
  .stat-value.success { color: var(--success); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
  }

  .card-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-title {
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  table { width: 100%; border-collapse: collapse; }

  th {
    padding: 10px 14px;
    text-align: left;
    font-size: 10px;
    font-family: var(--font-mono);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 12px 14px;
    font-size: 13px;
    border-bottom: 1px solid rgba(42,42,58,0.5);
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }

  .tool-name { font-weight: 600; color: var(--text); }
  .tool-id { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 100px;
    font-size: 11px;
    font-family: var(--font-mono);
    font-weight: 500;
  }

  .pill-dot { width: 5px; height: 5px; border-radius: 50%; }

  .pill.active { background: rgba(0,214,143,0.1); color: var(--success); }
  .pill.active .pill-dot { background: var(--success); }

  .pill.sharpening_needed { background: rgba(255,170,0,0.1); color: var(--warning); }
  .pill.sharpening_needed .pill-dot { background: var(--warning); }

  .pill.pending { background: rgba(255,170,0,0.1); color: var(--warning); }
  .pill.pending .pill-dot { background: var(--warning); }

  .pill.quoted { background: rgba(0,229,255,0.1); color: var(--accent); }
  .pill.quoted .pill-dot { background: var(--accent); }

  .pill.completed { background: rgba(0,214,143,0.1); color: var(--success); }
  .pill.completed .pill-dot { background: var(--success); }

  .pill.high { background: rgba(255,71,87,0.1); color: var(--danger); }
  .pill.high .pill-dot { background: var(--danger); }

  .pill.normal { background: rgba(107,107,138,0.1); color: var(--text-dim); }
  .pill.normal .pill-dot { background: var(--text-dim); }

  .resharp-info {
    font-family: var(--font-mono);
    font-size: 12px;
  }

  .resharp-bar {
    height: 4px;
    background: var(--surface2);
    border-radius: 100px;
    margin-top: 4px;
    overflow: hidden;
  }

  .resharp-fill {
    height: 100%;
    border-radius: 100px;
    background: var(--accent);
  }

  .resharp-fill.warn { background: var(--warning); }
  .resharp-fill.danger { background: var(--danger); }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    font-family: var(--font-body);
  }

  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #33ecff; }

  .btn-success { background: var(--success); color: #000; }
  .btn-success:hover { background: #33e8b0; }

  .btn-warning { background: var(--warning); color: #000; }
  .btn-warning:hover { background: #ffbb33; }

  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-lg { padding: 12px 24px; font-size: 15px; }

  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-title {
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 20px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }

  .modal-close {
    position: absolute;
    top: 18px;
    right: 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover { color: var(--text); border-color: var(--accent); }

  .form-group { margin-bottom: 14px; }

  .form-group label {
    display: block;
    font-size: 11px;
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 5px;
  }

  input, select, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 14px;
    font-family: var(--font-body);
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  textarea { resize: vertical; min-height: 80px; }

  .quote-box {
    background: rgba(0,229,255,0.05);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 10px;
    padding: 16px;
    margin-top: 16px;
  }

  .quote-box h4 {
    font-family: var(--font-display);
    font-size: 13px;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .quote-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 13px;
  }

  .quote-row .label { color: var(--text-dim); }
  .quote-row .value { font-weight: 600; }
  .quote-row .price { color: var(--accent); font-family: var(--font-mono); font-size: 18px; }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface);
    border: 1px solid var(--success);
    border-radius: 10px;
    padding: 14px 20px;
    font-size: 14px;
    color: var(--success);
    z-index: 999;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-dim);
  }

  .empty-state .icon { font-size: 36px; margin-bottom: 10px; }

  /* QR Scanner Styles */
  .scanner-layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 24px;
    align-items: start;
  }

  .scanner-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }

  .scanner-box {
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    aspect-ratio: 1;
  }

  #qr-reader {
    width: 100% !important;
  }

  #qr-reader video {
    border-radius: 8px;
  }

  #qr-reader__scan_region {
    min-height: 280px !important;
  }

  #qr-reader__dashboard {
    display: none !important;
  }

  .scanner-status {
    text-align: center;
    padding: 12px;
    font-size: 12px;
    color: var(--text-dim);
    border-top: 1px solid var(--border);
    margin-top: 12px;
  }

  .scanner-status.scanning {
    color: var(--success);
  }

  .scanner-status .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    margin-right: 8px;
    animation: pulse 1.5s infinite;
  }

  .scanner-status.scanning .dot {
    background: var(--success);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .tool-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    min-height: 400px;
  }

  .tool-panel-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: var(--text-dim);
    text-align: center;
    padding: 40px;
  }

  .tool-panel-empty .icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .tool-panel-content {
    padding: 24px;
  }

  .tool-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .tool-header-info h2 {
    font-family: var(--font-display);
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 4px;
  }

  .tool-header-info .id {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-dim);
  }

  .tool-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }

  .detail-item .label {
    font-size: 10px;
    font-family: var(--font-mono);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .detail-item .value {
    font-size: 14px;
    font-weight: 500;
  }

  .action-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 24px;
  }

  .usage-section {
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }

  .usage-section h3 {
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .usage-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .usage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 8px;
    margin-bottom: 6px;
    font-size: 13px;
  }

  .usage-item .user {
    font-weight: 500;
  }

  .usage-item .time {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
  }

  .usage-item .note {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .manual-input {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .manual-input-row {
    display: flex;
    gap: 8px;
  }

  .manual-input input {
    flex: 1;
    padding: 8px 12px;
    font-size: 13px;
  }

  @media (max-width: 900px) {
    .app-shell { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .page { padding: 16px; }
    .scanner-layout { grid-template-columns: 1fr; }
    .tool-details { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div class="app-shell">
  <aside class="sidebar">
    <div class="logo-area">
      <div class="logo-badge">â–¸ Three Lab</div>
      <div class="logo-title">å†ç ”ç£¨<span>ä¾é ¼</span>ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>
    <div class="customer-info">
      <div class="customer-name">ãƒ‡ãƒ¢é¡§å®¢æ ªå¼ä¼šç¤¾</div>
      <div>é¡§å®¢ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>
    <nav class="nav">
      <div class="nav-item" onclick="showPage('scanner')">
        <span class="nav-icon">â–£</span>
        QRã‚¹ã‚­ãƒ£ãƒ³
      </div>
      <div class="nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">â—‰</span>
        ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      </div>
      <div class="nav-item" onclick="showPage('tools')">
        <span class="nav-icon">âš™</span>
        å·¥å…·ä¸€è¦§
      </div>
      <div class="nav-item" onclick="showPage('usage')">
        <span class="nav-icon">ğŸ“‹</span>
        ä½¿ç”¨å±¥æ­´
      </div>
      <div class="nav-item" onclick="showPage('requests')">
        <span class="nav-icon">â†º</span>
        ä¾é ¼çŠ¶æ³
        <span class="status-badge" id="quoted-badge" style="display:none">0</span>
      </div>
    </nav>
  </aside>

  <main class="main">

    <!-- QR SCANNER PAGE -->
    <div class="page" id="page-scanner">
      <div class="page-header">
        <h1>QRã‚¹ã‚­ãƒ£ãƒ³</h1>
        <p>å·¥å…·ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ä½¿ç”¨è¨˜éŒ²ãƒ»å†ç ”ç£¨ä¾é ¼</p>
      </div>

      <div class="scanner-layout">
        <div>
          <div class="scanner-container">
            <div class="scanner-box">
              <div id="qr-reader"></div>
            </div>
            <div class="scanner-status" id="scanner-status">
              <span class="dot"></span>
              ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
            </div>
            <div class="manual-input">
              <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px">ã¾ãŸã¯å·¥å…·IDã‚’ç›´æ¥å…¥åŠ›</div>
              <div class="manual-input-row">
                <input type="text" id="manual-tool-id" placeholder="ä¾‹: tool-001">
                <button class="btn btn-outline btn-sm" onclick="lookupManualId()">æ¤œç´¢</button>
              </div>
            </div>
          </div>
        </div>

        <div class="tool-panel" id="tool-panel">
          <div class="tool-panel-empty" id="tool-panel-empty">
            <div class="icon">ğŸ“·</div>
            <div style="font-size:15px;font-weight:600;margin-bottom:8px">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
            <div style="font-size:13px">å·¥å…·ã«è²¼ã‚‰ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’<br>ã‚«ãƒ¡ãƒ©ã«ã‹ã–ã—ã¦ãã ã•ã„</div>
          </div>
          <div class="tool-panel-content" id="tool-panel-content" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p>å·¥å…·ã®å†ç ”ç£¨ä¾é ¼çŠ¶æ³</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ç™»éŒ²å·¥å…·æ•°</div>
          <div class="stat-value cyan" id="stat-total">â€”</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">ç¨¼åƒä¸­</div>
          <div class="stat-value success" id="stat-active">â€”</div>
        </div>
        <div class="stat-card warn">
          <div class="stat-label">ç ”ç£¨å¾…ã¡</div>
          <div class="stat-value warn" id="stat-sharpen">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">è¦‹ç©å›ç­”æ¸ˆ</div>
          <div class="stat-value cyan" id="stat-quoted">â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">æœ€è¿‘ã®ä¾é ¼çŠ¶æ³</div>
          <button class="btn btn-outline btn-sm" onclick="showPage('requests')">ã™ã¹ã¦è¦‹ã‚‹</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>å·¥å…·å</th>
              <th>æè³ª</th>
              <th>çŠ¶æ…‹</th>
              <th>è¦‹ç©</th>
              <th>ç´æœŸ</th>
            </tr>
          </thead>
          <tbody id="dashboard-requests"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ç ”ç£¨ãŒå¿…è¦ãªå·¥å…·</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>å·¥å…·å</th>
              <th>æè³ª</th>
              <th>ä½¿ç”¨å›æ•°</th>
              <th>å†ç ”ç£¨</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="dashboard-needs-sharpening"></tbody>
        </table>
      </div>
    </div>

    <!-- TOOLS PAGE -->
    <div class="page" id="page-tools">
      <div class="page-header">
        <h1>å·¥å…·ä¸€è¦§</h1>
        <p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å·¥å…·ã®ä¸€è¦§</p>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>å·¥å…·å</th>
              <th>ç¨®é¡</th>
              <th>æè³ª</th>
              <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
              <th>ä½¿ç”¨å›æ•°</th>
              <th>å†ç ”ç£¨å›æ•°</th>
              <th>çŠ¶æ…‹</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tools-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- USAGE PAGE -->
    <div class="page" id="page-usage">
      <div class="page-header">
        <h1>ä½¿ç”¨å±¥æ­´</h1>
        <p>å·¥å…·ã‚’é¸æŠã—ã¦ä½¿ç”¨è¨˜éŒ²ã‚’ç¢ºèª</p>
      </div>

      <div class="card">
        <div style="padding: 16px; border-bottom: 1px solid var(--border);">
          <select id="usage-tool-select" onchange="loadToolUsageHistory()" style="max-width: 400px;">
            <option value="">-- å·¥å…·ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
          </select>
        </div>
        <table>
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>ä½¿ç”¨è€…</th>
              <th>å‚™è€ƒ</th>
            </tr>
          </thead>
          <tbody id="usage-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- REQUESTS PAGE -->
    <div class="page" id="page-requests">
      <div class="page-header">
        <h1>ä¾é ¼çŠ¶æ³</h1>
        <p>å†ç ”ç£¨ä¾é ¼ã®é€²æ—ç¢ºèª</p>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>å·¥å…·å</th>
              <th>æè³ª</th>
              <th>ä¾é ¼æ—¥</th>
              <th>çŠ¶æ…‹</th>
              <th>è¦‹ç©é‡‘é¡</th>
              <th>ç´æœŸ</th>
              <th>å‚™è€ƒ</th>
            </tr>
          </thead>
          <tbody id="requests-tbody"></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<!-- REQUEST MODAL -->
<div class="modal-overlay" id="request-modal">
  <div class="modal">
    <div class="modal-title">å†ç ”ç£¨ä¾é ¼</div>
    <button class="modal-close" onclick="closeModal('request-modal')">âœ•</button>
    <input type="hidden" id="req-tool-id">
    <div class="form-group">
      <label>å·¥å…·å</label>
      <input type="text" id="req-tool-name" readonly style="background:var(--bg)">
    </div>
    <div class="form-group">
      <label>ã”æ‹…å½“è€…å *</label>
      <input type="text" id="req-requester" placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
    </div>
    <div class="form-group">
      <label>ä¾é ¼ç†ç”± *</label>
      <textarea id="req-reason" placeholder="ä¾‹: åˆƒå…ˆã®æ‘©è€—ã«ã‚ˆã‚Šåˆ‡å‰Šç²¾åº¦ãŒä½ä¸‹ã—ã¦ã„ã¾ã™"></textarea>
    </div>
    <div class="form-group">
      <label>å„ªå…ˆåº¦</label>
      <select id="req-priority">
        <option value="normal">é€šå¸¸</option>
        <option value="high">æ€¥ã</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;margin-top:20px;">
      <button class="btn btn-primary" onclick="submitRequest()">ä¾é ¼ã‚’é€ä¿¡</button>
      <button class="btn btn-outline" onclick="closeModal('request-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- USAGE MODAL -->
<div class="modal-overlay" id="usage-modal">
  <div class="modal">
    <div class="modal-title">ä½¿ç”¨è¨˜éŒ²</div>
    <button class="modal-close" onclick="closeModal('usage-modal')">âœ•</button>
    <input type="hidden" id="usage-tool-id">
    <div class="form-group">
      <label>å·¥å…·å</label>
      <input type="text" id="usage-tool-name" readonly style="background:var(--bg)">
    </div>
    <div class="form-group">
      <label>ä½¿ç”¨è€…å *</label>
      <input type="text" id="usage-user" placeholder="ä¾‹: å±±ç”° ä¸€éƒ">
    </div>
    <div class="form-group">
      <label>ä½¿ç”¨æ—¥æ™‚</label>
      <input type="datetime-local" id="usage-used-at">
    </div>
    <div class="form-group">
      <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="usage-notes" placeholder="ä¾‹: NCæ—‹ç›¤1å·æ©Ÿ">
    </div>
    <div style="display:flex;gap:8px;margin-top:20px;">
      <button class="btn btn-success" onclick="submitUsage()">ä½¿ç”¨ã‚’è¨˜éŒ²</button>
      <button class="btn btn-outline" onclick="closeModal('usage-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- QR MODAL -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal" style="max-width: 350px; text-align: center;">
    <div class="modal-title">QRã‚³ãƒ¼ãƒ‰</div>
    <button class="modal-close" onclick="closeModal('qr-modal')">âœ•</button>
    <div id="qr-tool-name" style="font-size: 16px; font-weight: 700; margin-bottom: 16px;"></div>
    <div id="qr-image-container" style="background: white; padding: 16px; border-radius: 8px; display: inline-block;"></div>
    <div style="margin-top: 24px;">
      <button class="btn btn-outline" onclick="closeModal('qr-modal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-title" id="detail-title">ä¾é ¼è©³ç´°</div>
    <button class="modal-close" onclick="closeModal('detail-modal')">âœ•</button>
    <div id="detail-content"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = 'http://localhost:8000/api';
let html5QrScanner = null;
let currentToolId = null;
let scannerActive = false;

const statusMap = {
  active: 'ç¨¼åƒä¸­',
  sharpening_needed: 'ç ”ç£¨å¾…ã¡',
  pending: 'è¦‹ç©å¾…ã¡',
  quoted: 'è¦‹ç©æ¸ˆ',
  completed: 'å®Œäº†'
};

const priorityMap = { normal: 'é€šå¸¸', high: 'æ€¥ã' };

function pillHtml(cls, text) {
  return `<span class="pill ${cls}"><span class="pill-dot"></span>${text}</span>`;
}

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.textContent.includes({dashboard:'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', tools:'å·¥å…·ä¸€è¦§', usage:'ä½¿ç”¨å±¥æ­´', requests:'ä¾é ¼çŠ¶æ³', scanner:'QRã‚¹ã‚­ãƒ£ãƒ³'}[id])) {
      n.classList.add('active');
    }
  });

  // Start/stop scanner based on page
  if (id === 'scanner') {
    startScanner();
  } else {
    stopScanner();
  }

  if (id === 'dashboard') loadDashboard();
  if (id === 'tools') loadTools();
  if (id === 'usage') loadUsage();
  if (id === 'requests') loadRequests();
}

function showToast(msg, isError=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = isError ? 'var(--danger)' : 'var(--success)';
  t.style.color = isError ? 'var(--danger)' : 'var(--success)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// === QR Scanner ===
async function startScanner() {
  if (scannerActive) return;

  const statusEl = document.getElementById('scanner-status');
  statusEl.innerHTML = '<span class="dot"></span>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
  statusEl.className = 'scanner-status';

  html5QrScanner = new Html5Qrcode("qr-reader");

  try {
    await html5QrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 220, height: 220 } },
      onScanSuccess,
      () => {}
    );
    scannerActive = true;
    statusEl.innerHTML = '<span class="dot"></span>ã‚¹ã‚­ãƒ£ãƒ³ä¸­... QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„';
    statusEl.className = 'scanner-status scanning';
  } catch (err) {
    console.error("Camera error:", err);
    statusEl.innerHTML = '<span class="dot"></span>ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“';
    statusEl.className = 'scanner-status';
  }
}

function stopScanner() {
  if (html5QrScanner && scannerActive) {
    html5QrScanner.stop().catch(() => {});
    scannerActive = false;
  }
}

function onScanSuccess(decodedText) {
  // Parse tool ID from QR code (format: "TOOL:tool-001")
  let toolId = decodedText;
  if (decodedText.startsWith('TOOL:')) {
    toolId = decodedText.replace('TOOL:', '');
  }

  // Avoid scanning same code repeatedly
  if (toolId === currentToolId) return;

  currentToolId = toolId;
  loadToolPanel(toolId);

  // Brief feedback
  showToast('QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ');
}

function lookupManualId() {
  const id = document.getElementById('manual-tool-id').value.trim();
  if (!id) return;
  currentToolId = id;
  loadToolPanel(id);
}

async function loadToolPanel(toolId) {
  const emptyEl = document.getElementById('tool-panel-empty');
  const contentEl = document.getElementById('tool-panel-content');

  try {
    const tool = await fetch(`${API}/tools/${toolId}`).then(r => {
      if (!r.ok) throw new Error('Not found');
      return r.json();
    });

    emptyEl.style.display = 'none';
    contentEl.style.display = 'block';

    const pct = (tool.resharpening_count / tool.max_resharpening) * 100;
    const barCls = pct >= 100 ? 'danger' : pct >= 66 ? 'warn' : '';
    const canRequest = tool.status !== 'sharpening_needed' && tool.resharpening_count < tool.max_resharpening;

    contentEl.innerHTML = `
      <div class="tool-header">
        <div class="tool-header-info">
          <h2>${tool.name}</h2>
          <div class="id">${tool.id}</div>
        </div>
        ${pillHtml(tool.status, statusMap[tool.status] || tool.status)}
      </div>

      <div class="tool-details">
        <div class="detail-item">
          <div class="label">ç¨®é¡</div>
          <div class="value">${tool.tool_type}</div>
        </div>
        <div class="detail-item">
          <div class="label">æè³ª</div>
          <div class="value">${tool.material || 'â€”'}</div>
        </div>
        <div class="detail-item">
          <div class="label">ãƒ¡ãƒ¼ã‚«ãƒ¼</div>
          <div class="value">${tool.manufacturer || 'â€”'}</div>
        </div>
        <div class="detail-item">
          <div class="label">ä½¿ç”¨å›æ•°</div>
          <div class="value" style="font-family:var(--font-mono);font-size:18px;color:var(--accent)">${tool.usage_count}å›</div>
        </div>
        <div class="detail-item">
          <div class="label">å†ç ”ç£¨å›æ•°</div>
          <div class="value">
            <span style="font-family:var(--font-mono)">${tool.resharpening_count} / ${tool.max_resharpening}</span>
            <div class="resharp-bar" style="margin-top:4px"><div class="resharp-fill ${barCls}" style="width:${Math.min(100,pct)}%"></div></div>
          </div>
        </div>
        <div class="detail-item">
          <div class="label">ä¿ç®¡å ´æ‰€</div>
          <div class="value">${tool.location || 'â€”'}</div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-success btn-lg" onclick="openUsageModal('${tool.id}','${tool.name}')">
          âœ“ ä½¿ç”¨ã‚’è¨˜éŒ²
        </button>
        ${canRequest ? `
        <button class="btn btn-warning btn-lg" onclick="openRequestModal('${tool.id}','${tool.name}')">
          â†º å†ç ”ç£¨ä¾é ¼
        </button>
        ` : ''}
      </div>

      <div class="usage-section">
        <h3>ğŸ“‹ ä½¿ç”¨å±¥æ­´</h3>
        <div class="usage-list" id="usage-list-${tool.id}">
          ${tool.usage_history && tool.usage_history.length > 0 ? tool.usage_history.map(u => `
            <div class="usage-item">
              <div>
                <div class="user">${u.used_by}</div>
                ${u.notes ? `<div class="note">${u.notes}</div>` : ''}
              </div>
              <div class="time">${formatDateTime(u.used_at)}</div>
            </div>
          `).join('') : '<div style="padding:20px;text-align:center;color:var(--text-dim)">ä½¿ç”¨å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>'}
        </div>
      </div>
    `;
  } catch (e) {
    emptyEl.style.display = 'flex';
    contentEl.style.display = 'none';
    showToast('å·¥å…·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + toolId, true);
    currentToolId = null;
  }
}

function formatDateTime(dt) {
  if (!dt) return 'â€”';
  const d = new Date(dt);
  return d.toLocaleDateString('ja-JP') + ' ' + d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
}

// === Usage Recording ===
function openUsageModal(toolId, toolName) {
  document.getElementById('usage-tool-id').value = toolId;
  document.getElementById('usage-tool-name').value = toolName;
  document.getElementById('usage-user').value = '';
  document.getElementById('usage-notes').value = '';
  
  // Set current datetime for usage-used-at
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for timezone
  document.getElementById('usage-used-at').value = now.toISOString().slice(0,16);
  
  openModal('usage-modal');
}

async function submitUsage() {
  const toolId = document.getElementById('usage-tool-id').value;
  const user = document.getElementById('usage-user').value.trim();
  const usedAt = document.getElementById('usage-used-at').value;
  const notes = document.getElementById('usage-notes').value.trim();

  if (!user) {
    showToast('ä½¿ç”¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
    return;
  }
  if (!usedAt) {
    showToast('ä½¿ç”¨æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
    return;
  }

  try {
    const r = await fetch(`${API}/tools/${toolId}/usage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ used_by: user, notes: notes || null, used_at: usedAt + ':00' }) // Backend expects seconds
    });
    if (!r.ok) throw new Error('ã‚¨ãƒ©ãƒ¼');

    const result = await r.json();
    closeModal('usage-modal');
    showToast(`ä½¿ç”¨ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆ${result.new_usage_count}å›ç›®ï¼‰`);

    // Reload tool panel and usage history if on correct page
    if (currentToolId === toolId) {
      loadToolPanel(toolId);
    }
    // If on usage history page and selected tool matches, reload
    const usageToolSelect = document.getElementById('usage-tool-select');
    if (document.getElementById('page-usage').classList.contains('active') && usageToolSelect.value === toolId) {
        loadToolUsageHistory();
    }

  } catch (e) {
    showToast('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  }
}

// === Stats ===
async function loadStats() {
  try {
    const d = await fetch(`${API}/stats`).then(r => r.json());
    document.getElementById('stat-total').textContent = d.total_tools;
    document.getElementById('stat-active').textContent = d.active_tools;
    document.getElementById('stat-sharpen').textContent = d.needs_sharpening;
    document.getElementById('stat-quoted').textContent = d.quoted_requests;

    const badge = document.getElementById('quoted-badge');
    if (d.quoted_requests > 0) {
      badge.style.display = '';
      badge.textContent = d.quoted_requests;
    } else {
      badge.style.display = 'none';
    }
  } catch(e) { console.error(e); }
}

async function loadDashboard() {
  await loadStats();

  // æœ€è¿‘ã®ä¾é ¼
  try {
    const reqs = await fetch(`${API}/sharpening-requests`).then(r => r.json());
    const tbody = document.getElementById('dashboard-requests');
    if (reqs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state">ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    } else {
      tbody.innerHTML = reqs.slice(0,5).map(r => `
        <tr onclick="showRequestDetail('${r.id}')" style="cursor:pointer">
          <td><div class="tool-name">${r.tool_name}</div><div class="tool-id">${r.tool_type}</div></td>
          <td>${r.material || 'â€”'}</td>
          <td>${pillHtml(r.status, statusMap[r.status] || r.status)}</td>
          <td style="font-family:var(--font-mono)">${r.estimated_price ? 'Â¥'+r.estimated_price.toLocaleString() : 'â€”'}</td>
          <td style="font-family:var(--font-mono)">${r.estimated_delivery || 'â€”'}</td>
        </tr>
      `).join('');
    }
  } catch(e) { console.error(e); }

  // ç ”ç£¨ãŒå¿…è¦ãªå·¥å…·
  try {
    const tools = await fetch(`${API}/tools?status=sharpening_needed`).then(r => r.json());
    const tbody = document.getElementById('dashboard-needs-sharpening');
    if (tools.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="icon">âœ“</div>ç ”ç£¨ãŒå¿…è¦ãªå·¥å…·ã¯ã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    } else {
      tbody.innerHTML = tools.map(t => {
        const pct = (t.resharpening_count / t.max_resharpening) * 100;
        const cls = pct >= 100 ? 'danger' : pct >= 66 ? 'warn' : '';
        return `
          <tr>
            <td><div class="tool-name">${t.name}</div><div class="tool-id">${t.id}</div></td>
            <td>${t.material || 'â€”'}</td>
            <td style="font-family:var(--font-mono)">${t.usage_count}å›</td>
            <td>
              <div class="resharp-info">${t.resharpening_count} / ${t.max_resharpening}</div>
              <div class="resharp-bar"><div class="resharp-fill ${cls}" style="width:${Math.min(100,pct)}%"></div></div>
            </td>
            <td><button class="btn btn-primary btn-sm" onclick="openRequestModal('${t.id}','${t.name}')">ä¾é ¼</button></td>
          </tr>
        `;
      }).join('');
    }
  } catch(e) { console.error(e); }
}

async function loadTools() {
  try {
    const tools = await fetch(`${API}/tools`).then(r => r.json());
    const tbody = document.getElementById('tools-tbody');
    tbody.innerHTML = tools.map(t => {
      const pct = (t.resharpening_count / t.max_resharpening) * 100;
      const cls = pct >= 100 ? 'danger' : pct >= 66 ? 'warn' : '';
      const canRequest = t.status !== 'sharpening_needed' && t.resharpening_count < t.max_resharpening;
      return `
        <tr>
          <td><div class="tool-name">${t.name}</div><div class="tool-id">${t.id}</div></td>
          <td>${t.tool_type}</td>
          <td>${t.material || 'â€”'}</td>
          <td>${t.manufacturer || 'â€”'}</td>
          <td style="font-family:var(--font-mono)">${t.usage_count}å›</td>
          <td>
            <div class="resharp-info">${t.resharpening_count} / ${t.max_resharpening}</div>
            <div class="resharp-bar"><div class="resharp-fill ${cls}" style="width:${Math.min(100,pct)}%"></div></div>
          </td>
          <td>${pillHtml(t.status, statusMap[t.status] || t.status)}</td>
          <td>
            <button class="btn btn-outline btn-sm" onclick="showQrCode('${t.id}', '${t.name}')">QRç™ºè¡Œ</button>
            ${canRequest ? `<button class="btn btn-outline btn-sm" onclick="openRequestModal('${t.id}','${t.name}')">å†ç ”ç£¨ä¾é ¼</button>` : ''}
          </td>
        </tr>
      `;
    }).join('');
  } catch(e) { console.error(e); }
}

async function loadUsage() {
  try {
    const tools = await fetch(`${API}/tools`).then(r => r.json());
    const select = document.getElementById('usage-tool-select');
    select.innerHTML = '<option value="">-- å·¥å…·ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>' + 
      tools.map(t => `<option value="${t.id}">${t.name} (${t.id})</option>`).join('');
    
    document.getElementById('usage-tbody').innerHTML = '<tr><td colspan="3"><div class="empty-state">å·¥å…·ã‚’é¸æŠã—ã¦ãã ã•ã„</div></td></tr>';
  } catch(e) { console.error(e); }
}

async function loadToolUsageHistory() {
  const toolId = document.getElementById('usage-tool-select').value;
  const tbody = document.getElementById('usage-tbody');
  
  if (!toolId) {
    tbody.innerHTML = '<tr><td colspan="3"><div class="empty-state">å·¥å…·ã‚’é¸æŠã—ã¦ãã ã•ã„</div></td></tr>';
    return;
  }
  
  try {
    const logs = await fetch(`${API}/tools/${toolId}/usage-history`).then(r => r.json());
    if (logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3"><div class="empty-state">ä½¿ç”¨å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    } else {
      tbody.innerHTML = logs.map(u => `
        <tr>
          <td style="font-family:var(--font-mono);font-size:12px">${formatDateTime(u.used_at)}</td>
          <td>${u.used_by}</td>
          <td style="font-size:12px;color:var(--text-dim)">${u.notes || 'â€”'}</td>
        </tr>
      `).join('');
    }
  } catch(e) { console.error(e); }
}

async function showQrCode(toolId, toolName) {
  try {
    const res = await fetch(`${API}/tools/${toolId}/qr`).then(r => r.json());
    document.getElementById('qr-tool-name').textContent = toolName;
    document.getElementById('qr-image-container').innerHTML = `<img src="${res.qr_code}" alt="QR Code" style="width: 200px; height: 200px; border: 1px solid var(--border); border-radius: 8px;">`;
    openModal('qr-modal');
  } catch(e) {
    showToast('QRã‚³ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  }
}

async function loadRequests() {
  try {
    const reqs = await fetch(`${API}/sharpening-requests`).then(r => r.json());
    const tbody = document.getElementById('requests-tbody');
    if (reqs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="icon">â†º</div>ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    } else {
      tbody.innerHTML = reqs.map(r => `
        <tr onclick="showRequestDetail('${r.id}')" style="cursor:pointer">
          <td><div class="tool-name">${r.tool_name}</div><div class="tool-id">${r.tool_type}</div></td>
          <td>${r.material || 'â€”'}</td>
          <td style="font-family:var(--font-mono);font-size:12px">${r.requested_at?.slice(0,10) || 'â€”'}</td>
          <td>${pillHtml(r.status, statusMap[r.status] || r.status)}</td>
          <td style="font-family:var(--font-mono);font-weight:600">${r.estimated_price ? 'Â¥'+r.estimated_price.toLocaleString() : 'â€”'}</td>
          <td style="font-family:var(--font-mono)">${r.estimated_delivery || 'â€”'}</td>
          <td style="font-size:12px;color:var(--text-dim);max-width:150px">${r.quote_notes || 'â€”'}</td>
        </tr>
      `).join('');
    }
  } catch(e) { console.error(e); }
}

function openRequestModal(toolId, toolName) {
  document.getElementById('req-tool-id').value = toolId;
  document.getElementById('req-tool-name').value = toolName;
  document.getElementById('req-requester').value = '';
  document.getElementById('req-reason').value = '';
  document.getElementById('req-priority').value = 'normal';
  openModal('request-modal');
}

async function submitRequest() {
  const toolId = document.getElementById('req-tool-id').value;
  const requester = document.getElementById('req-requester').value.trim();
  const reason = document.getElementById('req-reason').value.trim();
  const priority = document.getElementById('req-priority').value;

  if (!requester || !reason) {
    showToast('æ‹…å½“è€…åã¨ä¾é ¼ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
    return;
  }

  try {
    const r = await fetch(`${API}/sharpening-requests`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ tool_id: toolId, requested_by: requester, reason, priority })
    });
    if (!r.ok) {
      const err = await r.json();
      throw new Error(err.detail || 'ã‚¨ãƒ©ãƒ¼');
    }
    closeModal('request-modal');
    showToast('å†ç ”ç£¨ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    loadDashboard();
    // Reload tool panel if on scanner page
    if (currentToolId === toolId) {
      loadToolPanel(toolId);
    }
  } catch(e) {
    showToast(e.message, true);
  }
}

async function showRequestDetail(reqId) {
  try {
    const r = await fetch(`${API}/sharpening-requests/${reqId}`).then(r => r.json());
    document.getElementById('detail-title').textContent = 'ä¾é ¼è©³ç´°';
    document.getElementById('detail-content').innerHTML = `
      <div style="margin-bottom:16px">
        <div style="font-size:16px;font-weight:700;margin-bottom:4px">${r.tool_name}</div>
        <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim)">${r.tool_id}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div><span style="font-size:11px;color:var(--text-dim)">ç¨®é¡</span><div>${r.tool_type}</div></div>
        <div><span style="font-size:11px;color:var(--text-dim)">æè³ª</span><div>${r.material || 'â€”'}</div></div>
        <div><span style="font-size:11px;color:var(--text-dim)">ãƒ¡ãƒ¼ã‚«ãƒ¼</span><div>${r.manufacturer || 'â€”'}</div></div>
        <div><span style="font-size:11px;color:var(--text-dim)">å†ç ”ç£¨</span><div>${r.resharpening_count} / ${r.max_resharpening}å›</div></div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-bottom:16px">
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">ä¾é ¼ç†ç”±</div>
        <div style="font-size:13px">${r.reason}</div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:8px">ä¾é ¼è€…: ${r.requested_by} ï¼ ${r.requested_at?.slice(0,10) || ''}</div>
      </div>
      ${r.status === 'quoted' || r.status === 'completed' ? `
      <div class="quote-box">
        <h4>è¦‹ç©å›ç­”</h4>
        <div class="quote-row">
          <span class="label">è¦‹ç©é‡‘é¡</span>
          <span class="price">Â¥${r.estimated_price?.toLocaleString() || 'â€”'}</span>
        </div>
        <div class="quote-row">
          <span class="label">ç´æœŸ</span>
          <span class="value">${r.estimated_delivery || 'â€”'}</span>
        </div>
        ${r.quote_notes ? `<div style="margin-top:10px;font-size:12px;color:var(--text-dim)">${r.quote_notes}</div>` : ''}
      </div>
      ` : `
      <div style="text-align:center;padding:20px;color:var(--text-dim)">
        <div style="font-size:24px;margin-bottom:8px">â³</div>
        <div>è¦‹ç©å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„</div>
      </div>
      `}
    `;
    openModal('detail-modal');
  } catch(e) {
    showToast('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
  }
}

// Init
loadDashboard();
</script>
</body>
</html>
